name: CI

on: [push, pull_request]

jobs:
  build:
    name: build-${{ matrix.config.os }}
    runs-on: ${{ matrix.config.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - os: ubuntu
            conan_cache: /home/runner/.conan2
            extension: ""
          - os: windows
            conan_cache: C:\Users\runneradmin\.conan2
            extension: .exe
    steps:
    - uses: actions/checkout@v4

    # Conan deps are cached in different locations depending on OS
    - name: Cache Conan dependencies - ${{ matrix.config.os }}
      uses: actions/cache@v2
      with:
        path: ${{ matrix.config.conan_cache }}
        key: build-${{ matrix.config.os }}-cache-conan

    # Cache python deps for slower windows install
    - name: Cache pip dependencies - ${{ matrix.config.os }}
      if: startsWith(matrix.config.os, 'windows')
      uses: actions/cache@v2
      with:
        path: c:\users\runneradmin\appdata\local\pip\cache
        key: build-${{ matrix.config.os }}-cache-pip

    # Install dependencies
    - name: Use mingw on windows
      if: startsWith(matrix.config.os, 'windows')
      run: choco install mingw && del C:\Users\runneradmin\.conan2\profiles\default
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install dependencies
      run: pip install cmake ninja conan && make install

    # Build package
    - name: Build release package - ${{ matrix.config.os }}
      run: make prod

    # Binary artifact
    - name: Save binary artifact for debugging
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.config.os }}-sf3convert
        path: build/Prod/sf3convert${{ matrix.config.extension }}
        retention-days: 1

    # Test package
    - name: Test
      run: make test-prod
